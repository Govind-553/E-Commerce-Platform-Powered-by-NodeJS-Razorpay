<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login - Cartify</title>
  <link rel="icon" href="img/payment.png" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    :root{
      --accent-1: #6d28d9; /* purple */
      --accent-2: #06b6d4; /* teal */
      --accent-3: #ff7a59; /* coral */
      --card: rgba(255,255,255,0.92);
      --muted: #6b7280;
      --glass-shadow: 0 10px 30px rgba(11,17,28,0.12);
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; color:#0f172a; }

    /* --- Modern animated background --- */
    body{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      background: linear-gradient(180deg, #f7f9fc 0%, #eef6fb 40%, #f3f6ff 100%);
      overflow:hidden;
    }

    .bg {
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      overflow:hidden;
    }
    .blob {
      position:absolute;
      filter: blur(36px) saturate(110%);
      opacity:0.22;
      transform: translate3d(0,0,0);
      will-change: transform, opacity;
      border-radius: 50%;
      mix-blend-mode: screen;
      animation: floatY 9s ease-in-out infinite;
    }
    .blob.b1 { width:520px; height:520px; left:-10%; top:-8%; background: radial-gradient(circle at 30% 30%, var(--accent-1), transparent 35%), linear-gradient(135deg, var(--accent-1), var(--accent-2)); animation-duration: 12s; }
    .blob.b2 { width:420px; height:420px; right:-8%; bottom:-12%; background: linear-gradient(135deg, var(--accent-2), var(--accent-3)); opacity:0.18; animation-duration: 10s; animation-delay: 1.5s; }
    .blob.b3 { width:260px; height:260px; left:30%; bottom:6%; background: linear-gradient(135deg, #ffd6a5, #ff7a59); opacity:0.12; animation-duration: 14s; animation-delay: 0.6s; }

    @keyframes floatY {
      0% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-18px) scale(1.02); }
      100% { transform: translateY(0) scale(1); }
    }

    /* subtle grid lines / vignette */
    .vignette {
      position:fixed; inset:0; z-index:0; pointer-events:none;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(99,102,241,0.03), transparent 8%),
                  radial-gradient(900px 500px at 95% 90%, rgba(6,182,212,0.02), transparent 8%);
      mix-blend-mode: normal;
    }

    /* Container */
    .wrap {
      position:relative;
      z-index:10;
      width:100%;
      max-width:420px;
      margin: 28px;
      padding: 28px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--glass-shadow);
      backdrop-filter: blur(6px) saturate(120%);
      border: 1px solid rgba(13,18,31,0.04);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .wrap:focus-within, .wrap:hover { transform: translateY(-4px); box-shadow: 0 18px 50px rgba(11,17,28,0.12); }

    h2 { text-align:center; color:#0f172a; margin: 0 0 12px 0; font-weight:700; font-size:1.25rem; }
    .sub { text-align:center; color:var(--muted); font-size:0.9rem; margin-bottom:10px; }

    /* Tabs */
    .tabs { display:flex; gap:8px; margin-bottom: 18px; justify-content:center; }
    .tab {
      padding: 8px 14px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:600;
      color:var(--muted);
      background: transparent;
      border: 1px solid transparent;
      transition: all .18s ease;
      font-size:0.95rem;
    }
    .tab.active {
      background: linear-gradient(90deg, rgba(109,40,217,0.12), rgba(6,182,212,0.06));
      color: var(--accent-1);
      box-shadow: 0 6px 18px rgba(99,102,241,0.06);
      border-color: rgba(99,102,241,0.06);
    }

    form { margin-top: 6px; }
    .form-group { margin-bottom: 12px; }
    label { display:block; font-size:0.88rem; margin-bottom:6px; color:#334155; font-weight:600; }
    input {
      width:100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 2px solid rgba(15,23,42,0.06);
      background: rgba(255,255,255,0.9);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      font-size:1rem;
      transition: box-shadow .14s, border-color .14s;
    }

    .password-wrapper {
      position: relative;
      width: 100%;
    }
    .password-wrapper input {
      padding-right: 40px;
    }
    .toggle-password {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: var(--muted);
      background: none;
      border: none;
      font-size: 1rem;
      padding: 4px 8px;
      transition: color .14s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .toggle-password:hover {
      color: var(--accent-1);
    }
    input:focus {
      outline:none;
      border-color: rgba(99,102,241,0.95);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.1), 0 6px 20px rgba(99,102,241,0.08);
    }

    .btn {
      width:100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      font-weight:700;
      font-size:1rem;
      cursor:pointer;
    }
    .btn-primary {
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      color:white;
      box-shadow: 0 10px 30px rgba(79,70,229,0.12);
      transition: transform .12s ease, box-shadow .12s;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 18px 40px rgba(79,70,229,0.12); }
    .google-btn {
      width:100%;
      margin-top: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 10px;
      border-radius:10px;
      background: white;
      border: 1px solid rgba(15,23,42,0.04);
      cursor:pointer;
      font-weight:700;
    }
    .google-btn img { display:inline-block; vertical-align:middle; }

    .divider {
      display:flex; gap:10px; align-items:center; margin: 14px 0; color:var(--muted); font-weight:600; font-size:0.85rem;
    }
    .divider::before, .divider::after { content:""; flex:1; height:1px; background:linear-gradient(90deg, transparent, rgba(15,23,42,0.04), transparent); border-radius:1px; }

    .hidden { display:none; }

    /* small screens and niceties */
    @media (max-width: 480px) {
      .wrap { padding:18px; margin: 18px; max-width: 92%; border-radius: 14px; }
      h2 { font-size:1.1rem; }
      .tabs { gap:6px; }
      .tab { padding: 7px 10px; font-size:0.92rem; }
      input { padding: 10px; border-radius:8px; font-size:0.95rem; }
      .btn-primary { padding: 11px; border-radius: 8px; }
      .google-btn { padding: 10px; font-size:0.95rem; }
      .blob.b1 { display:none; } /* hide large blobs on tiny screens to reduce clutter */
      .blob.b2 { opacity:0.12; transform:scale(0.9); }
    }

    @media (min-width: 920px) {
      .wrap { transform: translateZ(0); } /* help GPU */
    }
  </style>
</head>
<body>

  <!-- background decorative layer (animated blobs + subtle vignette) -->
  <div class="bg" aria-hidden="true">
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div class="blob b3"></div>
  </div>
  <div class="vignette" aria-hidden="true"></div>

  <!-- main card -->
  <div class="wrap" role="main" aria-labelledby="authTitle">
    <div style="text-align:center; margin-bottom:6px;">
      <h2 id="authTitle">Welcome to Cartify</h2>
      <div class="sub">Sign in to manage your products and orders</div>
    </div>

    <div class="tabs" role="tablist" aria-label="Authentication tabs">
      <div class="tab active" role="tab" aria-selected="true" onclick="switchTab('login')">Login</div>
      <div class="tab" role="tab" aria-selected="false" onclick="switchTab('register')">Register</div>
    </div>

    <!-- Login Form -->
    <div id="login-form" role="region" aria-label="Login form">
      <form onsubmit="handleLogin(event)" novalidate>
        <div class="form-group">
          <label for="login-email">Email</label>
          <input id="login-email" type="email" required autocomplete="email">
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <div class="password-wrapper">
            <input id="login-password" type="password" required autocomplete="current-password">
            <button type="button" class="toggle-password" onclick="togglePassword('login-password')" aria-label="Toggle password visibility">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Login</button>
      </form>
    </div>

    <!-- Register Form -->
    <div id="register-form" class="hidden" role="region" aria-label="Register form">
      <form onsubmit="handleRegister(event)" novalidate>
        <div class="form-group">
          <label for="reg-name">Name</label>
          <input id="reg-name" type="text" required autocomplete="name">
        </div>
        <div class="form-group">
          <label for="reg-email">Email</label>
          <input id="reg-email" type="email" required autocomplete="email">
        </div>
        <div class="form-group">
          <label for="reg-password">Password</label>
          <div class="password-wrapper">
            <input id="reg-password" type="password" required autocomplete="new-password">
            <button type="button" class="toggle-password" onclick="togglePassword('reg-password')" aria-label="Toggle password visibility">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Register</button>
      </form>
    </div>

    <div class="divider"><span>OR CONTINUE WITH</span></div>

    <button class="google-btn" onclick="signInWithGoogle()" aria-label="Continue with Google">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" height="20" alt="">
      Continue with Google
    </button>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="js/firebaseConfig.js"></script>
  <script src="js/toast.js"></script>
  <script src="js/config.js"></script>

  <script>
    // Config initialized in firebaseConfig.js
    const auth = firebase.auth();

    function togglePassword(fieldId) {
      const field = document.getElementById(fieldId);
      const button = field.nextElementSibling;
      const icon = button.querySelector('i');
      
      if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      if(tab === 'login') {
        document.querySelector('.tab:nth-child(1)').classList.add('active');
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('register-form').classList.add('hidden');
      } else {
        document.querySelector('.tab:nth-child(2)').classList.add('active');
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.remove('hidden');
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        Toast.show('Login successful! Redirecting...', 'success');
        await postAuth(userCredential.user);
      } catch (error) {
        Toast.show('Login failed: ' + (error.message || error), 'error');
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const name = document.getElementById('reg-name').value;
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-password').value;

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        await user.updateProfile({ displayName: name });
        Toast.show('Registration successful!', 'success');
        await postAuth(user);
      } catch (error) {
        Toast.show('Registration failed: ' + (error.message || error), 'error');
      }
    }

    async function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const result = await auth.signInWithPopup(provider);
        Toast.show('Google Sign-In successful!', 'success');
        await postAuth(result.user);
      } catch (error) {
        console.error(error);
        Toast.show('Google Sign-In Failed: ' + (error.message || error), 'error');
      }
    }

    async function postAuth(user) {
      try {
        const token = await user.getIdToken();
        // store token in localStorage and also set a cookie so server-side page guards can read it
        localStorage.setItem('authToken', token);
        // set session cookie (will be sent to server) -- path=/ so it's available site-wide
        document.cookie = 'authToken=' + encodeURIComponent(token) + '; path=/;';

        // Sync user with backend
        const syncRes = await fetch(`${BACKEND_API_URL}/api/auth/sync`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if(syncRes.ok) {
          const data = await syncRes.json();
          // Store user role
          localStorage.setItem('userRole', data.role);
          setTimeout(() => {
            if (data.role === 'admin') {
              window.location.href = '/admin';
            } else {
              window.location.href = '/';
            }
          }, 850); // short delay for toast visibility
        } else {
          console.error("Sync failed");
          window.location.href = '/';
        }
      } catch (err) {
        console.error(err);
        Toast.show("Authentication processing failed.", 'error');
      }
    }
  </script>
</body>
</html>
